#!/usr/bin/ruby

ENV['CONFIGURATION_LIBRARY_PATH'] = '@CONFIGURATION_LIBRARY_PATH@'
ENV['CONFIGURATION_PATH'] = '@CONFIGURATION_PATH@'
ENV['LOADER_LIBRARY_PATH'] = '@LOADER_LIBRARY_PATH@'
ENV['LOADER_SCRIPT_PATH'] = '@LOADER_SCRIPT_PATH@'

require 'test/unit'
require 'net/http'

class RbRailsTest < Test::Unit::TestCase

	def test_rails
		puts 'Launching ruby on rails server in background'

		io = IO.popen('@LOADER_SCRIPT_PATH@/blog.rb')

		pid = io.pid

		assert_not_equal(0, pid)

		sleep 3

		puts 'Connecting to server...'

		uri = URI.parse('http://localhost:3000')

		http = Net::HTTP.new(uri.host, uri.port)

		result = http.request(Net::HTTP::Get.new(uri.request_uri))

		assert_not_equal('', result.body)

		puts 'Request content:', result.body[0..90] + '...'

		puts 'Killing server...'

		begin
			Process.kill("INT", pid)
		rescue StandardError
			exit 0		
		end
	end
end
